# Claude API 中转站 - 使用说明文档

## 项目概述

Claude API 中转站是一个功能完整的 API 代理服务，用于管理和转发 Claude API 请求。提供API密钥管理、使用量统计、配额控制等功能，适用于需要集中管理多个用户Claude API使用的场景。

## 🌟 核心功能

### API 密钥管理
- 🔑 创建和管理中转站API密钥
- 🔒 密钥哈希存储，支持IP和域名白名单
- ⏰ 支持密钥过期时间设置
- 🎯 灵活的配额和速率限制控制

### 使用量追踪
- 📊 实时令牌使用量统计
- 📈 每日使用量趋势分析
- 📋 详细的请求日志记录
- 💰 成本计算和统计

### 监控与管理
- 🔍 Prometheus指标导出
- 📊 Grafana仪表板支持
- 👥 管理员后台管理界面
- 🚨 配额告警和通知

## 🚀 快速开始

### 环境要求
- Python 3.11+
- PostgreSQL 14+
- Redis 6+
- Docker & Docker Compose (推荐)

### 部署方式

#### 方式一：Docker Compose (推荐)

1. **环境配置**
```bash
# 克隆项目
git clone <repository>
cd claude-code-switch

# 配置环境变量
cp .env.example .env
# 编辑 .env 文件，设置必要变量
```

2. **启动服务**
```bash
# 启动所有服务
docker-compose up -d

# 运行数据库迁移
docker-compose exec relay-station alembic upgrade head
```

#### 方式二：手动部署

1. **安装依赖**
```bash
pip install -r requirements.txt
```

2. **数据库初始化**
```bash
# 运行迁移
alembic upgrade head
```

3. **启动服务**
```bash
# 开发模式
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# 生产模式
python run.py
```

## ⚙️ 配置说明

### 环境变量配置

**必须配置的环境变量：**

```env
# 上游API配置
UPSTREAM_API_URL=https://api.anthropic.com/v1
UPSTREAM_API_KEY=your-anthropic-api-key-here

# 管理员账号
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your-secure-password

# 安全密钥 (使用 openssl rand -hex 32 生成)
SECRET_KEY=your-secret-key

# 数据库连接
DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:15432/relay_station

# Redis连接
REDIS_URL=redis://:123456@localhost:16379/0
```

### 高级配置 (config.yaml)

```yaml
upstream:
  primary:
    url: "${UPSTREAM_API_URL}"
    api_key: "${UPSTREAM_API_KEY}"
    timeout: 60
    max_retries: 3

rate_limit:
  by_tier:
    basic:
      requests: 100
      period: 60
    premium:
      requests: 1000
      period: 60
```

## 📖 使用指南

### 管理员操作

#### 1. 登录获取管理员令牌

```bash
curl -X POST http://117.72.196.48:8000/admin/login \
  -u admin:chen
```

**响应示例：**
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "token_type": "bearer",
  "expires_in": 86400
}
```

#### 2. 创建API密钥

```bash
curl -X POST http://117.72.196.48:8000/admin/api-keys \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "用户测试密钥",
    "description": "测试用密钥",
    "token_limit": 1000000,
    "rate_limit_tier": "basic",
    "expires_in_days": 30
  }'
```

**响应示例：**
```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "api_key": "sk-proxy-xxx...", 
  "name": "用户测试密钥",
  "token_limit": 1000000,
  "created_at": "2025-08-22T13:00:00Z"
}
```

#### 3. 管理API密钥

```bash
# 查看所有密钥
curl -X GET http://117.72.196.48:8000/admin/api-keys \
  -H "Authorization: Bearer <admin-token>"

# 禁用密钥
curl -X POST http://117.72.196.48:8000/admin/api-keys/{id}/disable \
  -H "Authorization: Bearer <admin-token>"

# 启用密钥
curl -X POST http://117.72.196.48:8000/admin/api-keys/{id}/enable \
  -H "Authorization: Bearer <admin-token>"

# 删除密钥
curl -X DELETE http://117.72.196.48:8000/admin/api-keys/{id} \
  -H "Authorization: Bearer <admin-token>"
```

### 用户使用

#### 1. 配置客户端

**Claude Code 配置：**
```bash
export ANTHROPIC_API_KEY=sk-proxy-xxx...
export ANTHROPIC_BASE_URL=http://117.72.196.48:8000
```

**Python 客户端配置：**
```python
import anthropic

client = anthropic.Anthropic(
    api_key="sk-proxy-xxx...",
    base_url="http://117.72.196.48:8000"
)
```

#### 2. 使用统计查询

```bash
# 查询使用统计
curl -X GET http://117.72.196.48:8000/api/usage \
  -H "Authorization: Bearer sk-proxy-xxx..."

# 查询配额状态
curl -X GET http://117.72.196.48:8000/api/usage/quota \
  -H "Authorization: Bearer sk-proxy-xxx..."

# 查询每日使用量
curl -X GET http://117.72.196.48:8000/api/usage/daily?days=7 \
  -H "Authorization: Bearer sk-proxy-xxx..."

# 查询详细日志
curl -X GET http://117.72.196.48:8000/api/usage/logs?limit=10 \
  -H "Authorization: Bearer sk-proxy-xxx..."
```

## 🔗 API 端点文档

### 公共端点
- `GET /` - 服务状态
- `GET /health` - 健康检查
- `GET /metrics` - Prometheus指标

### 管理员端点 (需要管理员认证)
- `POST /admin/login` - 管理员登录
- `POST /admin/api-keys` - 创建API密钥
- `GET /admin/api-keys` - 列出所有密钥
- `GET /admin/api-keys/{id}` - 获取密钥详情
- `GET /admin/api-keys/{id}/stats` - 获取密钥统计
- `POST /admin/api-keys/{id}/disable` - 禁用密钥
- `POST /admin/api-keys/{id}/enable` - 启用密钥
- `DELETE /admin/api-keys/{id}` - 删除密钥

### 用户端点 (需要API密钥)
- `GET /api/usage` - 使用统计
- `GET /api/usage/daily` - 每日使用量
- `GET /api/usage/logs` - 使用日志
- `GET /api/usage/quota` - 配额状态

### 代理端点
- `POST /v1/messages` - Claude消息API (所有Claude API路径)
- `/*` - 其他所有请求转发至上游API

## 🔍 监控和可视化

### Swagger UI
访问 http://117.72.196.48:8000/admin/docs 查看完整的API文档和测试界面。

### Prometheus 指标
访问 http://117.72.196.48:8000/metrics 查看以下指标：
- `relay_requests_total` - 请求总数
- `proxy_duration_seconds` - 代理延迟
- `tokens_used_total` - 令牌使用量
- `token_quota_usage_ratio` - 配额使用率

### 日志监控
服务提供结构化JSON日志，包含：
- 请求ID追踪
- 用户API密钥
- 令牌使用量
- 响应时间
- 错误信息

## 🔒 安全建议

### 生产环境配置
1. **使用HTTPS**: 配置反向代理(Nginx)启用SSL
2. **强密码**: 使用复杂的管理员密码和SECRET_KEY
3. **IP限制**: 限制管理端点的访问IP
4. **防火墙**: 只开放必要的端口

### 密钥管理
1. **定期轮换**: 定期更换管理员密码和API密钥
2. **最小权限**: 为不同应用创建独立的API密钥
3. **合理配额**: 设置合理的令牌限制和过期时间
4. **白名单**: 配置IP和域名白名单

### 监控告警
1. **配额告警**: 设置使用量接近配额时的告警
2. **异常检测**: 监控异常请求模式和错误率
3. **日志审计**: 定期审查使用日志和访问记录

## 🛠️ 故障排除

### 常见问题解决

**1. 服务无法启动**
```bash
# 检查端口占用
netstat -tulpn | grep :8000

# 检查数据库连接
curl http://localhost:8000/health
```

**2. API密钥验证失败**
```bash
# 检查密钥格式
echo "sk-proxy-xxx..." | wc -c

# 测试密钥有效性
curl -X GET http://117.72.196.48:8000/api/usage/quota \
  -H "Authorization: Bearer sk-proxy-xxx..."
```

**3. 上游API连接超时**
```bash
# 测试网络连接
curl -I https://api.anthropic.com/v1/messages

# 检查API密钥
curl -X POST https://api.anthropic.com/v1/messages \
  -H "Authorization: Bearer your-real-api-key"
```

**4. 数据库连接问题**
```bash
# 检查PostgreSQL状态
docker ps | grep postgres

# 测试数据库连接
psql postgresql://postgres:postgres@localhost:15432/relay_station
```

## 📈 性能优化

### 数据库优化
- 定期清理过期的使用日志
- 为高频查询添加索引
- 配置合适的连接池大小

### 缓存策略
- 使用Redis缓存API密钥验证结果
- 缓存使用统计查询结果
- 配置合适的缓存过期时间

### 负载均衡
- 支持多实例部署
- 使用Nginx进行负载均衡
- 配置健康检查

## 🔧 开发和维护

### 开发环境
```bash
# 安装开发依赖
pip install -r requirements.txt

# 运行测试
pytest tests/

# 代码格式化
black app/
flake8 app/
```

### 数据库迁移
```bash
# 创建迁移
alembic revision --autogenerate -m "描述"

# 应用迁移
alembic upgrade head

# 回滚迁移
alembic downgrade -1
```

### 日志级别配置
```env
LOG_LEVEL=INFO  # DEBUG, INFO, WARNING, ERROR
```

## 📞 技术支持

### 服务状态检查
- **服务地址**: http://117.72.196.48:8000/
- **健康检查**: http://117.72.196.48:8000/health  
- **API文档**: http://117.72.196.48:8000/admin/docs
- **管理员账号**: admin / chen

### 联系方式
如遇到问题，请通过以下方式联系：
1. 提交GitHub Issue
2. 查看项目文档
3. 检查日志输出

---

*Claude API 中转站 v0.1.0 - 企业级API代理服务*