# Claude API ä¸­è½¬ç«™ - ä½¿ç”¨è¯´æ˜æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

Claude API ä¸­è½¬ç«™æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ API ä»£ç†æœåŠ¡ï¼Œç”¨äºç®¡ç†å’Œè½¬å‘ Claude API è¯·æ±‚ã€‚æä¾›APIå¯†é’¥ç®¡ç†ã€ä½¿ç”¨é‡ç»Ÿè®¡ã€é…é¢æ§åˆ¶ç­‰åŠŸèƒ½ï¼Œé€‚ç”¨äºéœ€è¦é›†ä¸­ç®¡ç†å¤šä¸ªç”¨æˆ·Claude APIä½¿ç”¨çš„åœºæ™¯ã€‚

## ğŸŒŸ æ ¸å¿ƒåŠŸèƒ½

### API å¯†é’¥ç®¡ç†
- ğŸ”‘ åˆ›å»ºå’Œç®¡ç†ä¸­è½¬ç«™APIå¯†é’¥
- ğŸ”’ å¯†é’¥å“ˆå¸Œå­˜å‚¨ï¼Œæ”¯æŒIPå’ŒåŸŸåç™½åå•
- â° æ”¯æŒå¯†é’¥è¿‡æœŸæ—¶é—´è®¾ç½®
- ğŸ¯ çµæ´»çš„é…é¢å’Œé€Ÿç‡é™åˆ¶æ§åˆ¶

### ä½¿ç”¨é‡è¿½è¸ª
- ğŸ“Š å®æ—¶ä»¤ç‰Œä½¿ç”¨é‡ç»Ÿè®¡
- ğŸ“ˆ æ¯æ—¥ä½¿ç”¨é‡è¶‹åŠ¿åˆ†æ
- ğŸ“‹ è¯¦ç»†çš„è¯·æ±‚æ—¥å¿—è®°å½•
- ğŸ’° æˆæœ¬è®¡ç®—å’Œç»Ÿè®¡

### ç›‘æ§ä¸ç®¡ç†
- ğŸ” PrometheusæŒ‡æ ‡å¯¼å‡º
- ğŸ“Š Grafanaä»ªè¡¨æ¿æ”¯æŒ
- ğŸ‘¥ ç®¡ç†å‘˜åå°ç®¡ç†ç•Œé¢
- ğŸš¨ é…é¢å‘Šè­¦å’Œé€šçŸ¥

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Python 3.11+
- PostgreSQL 14+
- Redis 6+
- Docker & Docker Compose (æ¨è)

### éƒ¨ç½²æ–¹å¼

#### æ–¹å¼ä¸€ï¼šDocker Compose (æ¨è)

1. **ç¯å¢ƒé…ç½®**
```bash
# å…‹éš†é¡¹ç›®
git clone <repository>
cd claude-code-switch

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œè®¾ç½®å¿…è¦å˜é‡
```

2. **å¯åŠ¨æœåŠ¡**
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# è¿è¡Œæ•°æ®åº“è¿ç§»
docker-compose exec relay-station alembic upgrade head
```

#### æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²

1. **å®‰è£…ä¾èµ–**
```bash
pip install -r requirements.txt
```

2. **æ•°æ®åº“åˆå§‹åŒ–**
```bash
# è¿è¡Œè¿ç§»
alembic upgrade head
```

3. **å¯åŠ¨æœåŠ¡**
```bash
# å¼€å‘æ¨¡å¼
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# ç”Ÿäº§æ¨¡å¼
python run.py
```

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®

**å¿…é¡»é…ç½®çš„ç¯å¢ƒå˜é‡ï¼š**

```env
# ä¸Šæ¸¸APIé…ç½®
UPSTREAM_API_URL=https://api.anthropic.com/v1
UPSTREAM_API_KEY=your-anthropic-api-key-here

# ç®¡ç†å‘˜è´¦å·
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your-secure-password

# å®‰å…¨å¯†é’¥ (ä½¿ç”¨ openssl rand -hex 32 ç”Ÿæˆ)
SECRET_KEY=your-secret-key

# æ•°æ®åº“è¿æ¥
DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:15432/relay_station

# Redisè¿æ¥
REDIS_URL=redis://:123456@localhost:16379/0
```

### é«˜çº§é…ç½® (config.yaml)

```yaml
upstream:
  primary:
    url: "${UPSTREAM_API_URL}"
    api_key: "${UPSTREAM_API_KEY}"
    timeout: 60
    max_retries: 3

rate_limit:
  by_tier:
    basic:
      requests: 100
      period: 60
    premium:
      requests: 1000
      period: 60
```

## ğŸ“– ä½¿ç”¨æŒ‡å—

### ç®¡ç†å‘˜æ“ä½œ

#### 1. ç™»å½•è·å–ç®¡ç†å‘˜ä»¤ç‰Œ

```bash
curl -X POST http://117.72.196.48:8000/admin/login \
  -u admin:chen
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "token_type": "bearer",
  "expires_in": 86400
}
```

#### 2. åˆ›å»ºAPIå¯†é’¥

```bash
curl -X POST http://117.72.196.48:8000/admin/api-keys \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "ç”¨æˆ·æµ‹è¯•å¯†é’¥",
    "description": "æµ‹è¯•ç”¨å¯†é’¥",
    "token_limit": 1000000,
    "rate_limit_tier": "basic",
    "expires_in_days": 30
  }'
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "api_key": "sk-proxy-xxx...", 
  "name": "ç”¨æˆ·æµ‹è¯•å¯†é’¥",
  "token_limit": 1000000,
  "created_at": "2025-08-22T13:00:00Z"
}
```

#### 3. ç®¡ç†APIå¯†é’¥

```bash
# æŸ¥çœ‹æ‰€æœ‰å¯†é’¥
curl -X GET http://117.72.196.48:8000/admin/api-keys \
  -H "Authorization: Bearer <admin-token>"

# ç¦ç”¨å¯†é’¥
curl -X POST http://117.72.196.48:8000/admin/api-keys/{id}/disable \
  -H "Authorization: Bearer <admin-token>"

# å¯ç”¨å¯†é’¥
curl -X POST http://117.72.196.48:8000/admin/api-keys/{id}/enable \
  -H "Authorization: Bearer <admin-token>"

# åˆ é™¤å¯†é’¥
curl -X DELETE http://117.72.196.48:8000/admin/api-keys/{id} \
  -H "Authorization: Bearer <admin-token>"
```

### ç”¨æˆ·ä½¿ç”¨

#### 1. é…ç½®å®¢æˆ·ç«¯

**Claude Code é…ç½®ï¼š**
```bash
export ANTHROPIC_API_KEY=sk-proxy-xxx...
export ANTHROPIC_BASE_URL=http://117.72.196.48:8000
```

**Python å®¢æˆ·ç«¯é…ç½®ï¼š**
```python
import anthropic

client = anthropic.Anthropic(
    api_key="sk-proxy-xxx...",
    base_url="http://117.72.196.48:8000"
)
```

#### 2. ä½¿ç”¨ç»Ÿè®¡æŸ¥è¯¢

```bash
# æŸ¥è¯¢ä½¿ç”¨ç»Ÿè®¡
curl -X GET http://117.72.196.48:8000/api/usage \
  -H "Authorization: Bearer sk-proxy-xxx..."

# æŸ¥è¯¢é…é¢çŠ¶æ€
curl -X GET http://117.72.196.48:8000/api/usage/quota \
  -H "Authorization: Bearer sk-proxy-xxx..."

# æŸ¥è¯¢æ¯æ—¥ä½¿ç”¨é‡
curl -X GET http://117.72.196.48:8000/api/usage/daily?days=7 \
  -H "Authorization: Bearer sk-proxy-xxx..."

# æŸ¥è¯¢è¯¦ç»†æ—¥å¿—
curl -X GET http://117.72.196.48:8000/api/usage/logs?limit=10 \
  -H "Authorization: Bearer sk-proxy-xxx..."
```

## ğŸ”— API ç«¯ç‚¹æ–‡æ¡£

### å…¬å…±ç«¯ç‚¹
- `GET /` - æœåŠ¡çŠ¶æ€
- `GET /health` - å¥åº·æ£€æŸ¥
- `GET /metrics` - PrometheusæŒ‡æ ‡

### ç®¡ç†å‘˜ç«¯ç‚¹ (éœ€è¦ç®¡ç†å‘˜è®¤è¯)
- `POST /admin/login` - ç®¡ç†å‘˜ç™»å½•
- `POST /admin/api-keys` - åˆ›å»ºAPIå¯†é’¥
- `GET /admin/api-keys` - åˆ—å‡ºæ‰€æœ‰å¯†é’¥
- `GET /admin/api-keys/{id}` - è·å–å¯†é’¥è¯¦æƒ…
- `GET /admin/api-keys/{id}/stats` - è·å–å¯†é’¥ç»Ÿè®¡
- `POST /admin/api-keys/{id}/disable` - ç¦ç”¨å¯†é’¥
- `POST /admin/api-keys/{id}/enable` - å¯ç”¨å¯†é’¥
- `DELETE /admin/api-keys/{id}` - åˆ é™¤å¯†é’¥

### ç”¨æˆ·ç«¯ç‚¹ (éœ€è¦APIå¯†é’¥)
- `GET /api/usage` - ä½¿ç”¨ç»Ÿè®¡
- `GET /api/usage/daily` - æ¯æ—¥ä½¿ç”¨é‡
- `GET /api/usage/logs` - ä½¿ç”¨æ—¥å¿—
- `GET /api/usage/quota` - é…é¢çŠ¶æ€

### ä»£ç†ç«¯ç‚¹
- `POST /v1/messages` - Claudeæ¶ˆæ¯API (æ‰€æœ‰Claude APIè·¯å¾„)
- `/*` - å…¶ä»–æ‰€æœ‰è¯·æ±‚è½¬å‘è‡³ä¸Šæ¸¸API

## ğŸ” ç›‘æ§å’Œå¯è§†åŒ–

### Swagger UI
è®¿é—® http://117.72.196.48:8000/admin/docs æŸ¥çœ‹å®Œæ•´çš„APIæ–‡æ¡£å’Œæµ‹è¯•ç•Œé¢ã€‚

### Prometheus æŒ‡æ ‡
è®¿é—® http://117.72.196.48:8000/metrics æŸ¥çœ‹ä»¥ä¸‹æŒ‡æ ‡ï¼š
- `relay_requests_total` - è¯·æ±‚æ€»æ•°
- `proxy_duration_seconds` - ä»£ç†å»¶è¿Ÿ
- `tokens_used_total` - ä»¤ç‰Œä½¿ç”¨é‡
- `token_quota_usage_ratio` - é…é¢ä½¿ç”¨ç‡

### æ—¥å¿—ç›‘æ§
æœåŠ¡æä¾›ç»“æ„åŒ–JSONæ—¥å¿—ï¼ŒåŒ…å«ï¼š
- è¯·æ±‚IDè¿½è¸ª
- ç”¨æˆ·APIå¯†é’¥
- ä»¤ç‰Œä½¿ç”¨é‡
- å“åº”æ—¶é—´
- é”™è¯¯ä¿¡æ¯

## ğŸ”’ å®‰å…¨å»ºè®®

### ç”Ÿäº§ç¯å¢ƒé…ç½®
1. **ä½¿ç”¨HTTPS**: é…ç½®åå‘ä»£ç†(Nginx)å¯ç”¨SSL
2. **å¼ºå¯†ç **: ä½¿ç”¨å¤æ‚çš„ç®¡ç†å‘˜å¯†ç å’ŒSECRET_KEY
3. **IPé™åˆ¶**: é™åˆ¶ç®¡ç†ç«¯ç‚¹çš„è®¿é—®IP
4. **é˜²ç«å¢™**: åªå¼€æ”¾å¿…è¦çš„ç«¯å£

### å¯†é’¥ç®¡ç†
1. **å®šæœŸè½®æ¢**: å®šæœŸæ›´æ¢ç®¡ç†å‘˜å¯†ç å’ŒAPIå¯†é’¥
2. **æœ€å°æƒé™**: ä¸ºä¸åŒåº”ç”¨åˆ›å»ºç‹¬ç«‹çš„APIå¯†é’¥
3. **åˆç†é…é¢**: è®¾ç½®åˆç†çš„ä»¤ç‰Œé™åˆ¶å’Œè¿‡æœŸæ—¶é—´
4. **ç™½åå•**: é…ç½®IPå’ŒåŸŸåç™½åå•

### ç›‘æ§å‘Šè­¦
1. **é…é¢å‘Šè­¦**: è®¾ç½®ä½¿ç”¨é‡æ¥è¿‘é…é¢æ—¶çš„å‘Šè­¦
2. **å¼‚å¸¸æ£€æµ‹**: ç›‘æ§å¼‚å¸¸è¯·æ±‚æ¨¡å¼å’Œé”™è¯¯ç‡
3. **æ—¥å¿—å®¡è®¡**: å®šæœŸå®¡æŸ¥ä½¿ç”¨æ—¥å¿—å’Œè®¿é—®è®°å½•

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜è§£å†³

**1. æœåŠ¡æ— æ³•å¯åŠ¨**
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tulpn | grep :8000

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
curl http://localhost:8000/health
```

**2. APIå¯†é’¥éªŒè¯å¤±è´¥**
```bash
# æ£€æŸ¥å¯†é’¥æ ¼å¼
echo "sk-proxy-xxx..." | wc -c

# æµ‹è¯•å¯†é’¥æœ‰æ•ˆæ€§
curl -X GET http://117.72.196.48:8000/api/usage/quota \
  -H "Authorization: Bearer sk-proxy-xxx..."
```

**3. ä¸Šæ¸¸APIè¿æ¥è¶…æ—¶**
```bash
# æµ‹è¯•ç½‘ç»œè¿æ¥
curl -I https://api.anthropic.com/v1/messages

# æ£€æŸ¥APIå¯†é’¥
curl -X POST https://api.anthropic.com/v1/messages \
  -H "Authorization: Bearer your-real-api-key"
```

**4. æ•°æ®åº“è¿æ¥é—®é¢˜**
```bash
# æ£€æŸ¥PostgreSQLçŠ¶æ€
docker ps | grep postgres

# æµ‹è¯•æ•°æ®åº“è¿æ¥
psql postgresql://postgres:postgres@localhost:15432/relay_station
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–
- å®šæœŸæ¸…ç†è¿‡æœŸçš„ä½¿ç”¨æ—¥å¿—
- ä¸ºé«˜é¢‘æŸ¥è¯¢æ·»åŠ ç´¢å¼•
- é…ç½®åˆé€‚çš„è¿æ¥æ± å¤§å°

### ç¼“å­˜ç­–ç•¥
- ä½¿ç”¨Redisç¼“å­˜APIå¯†é’¥éªŒè¯ç»“æœ
- ç¼“å­˜ä½¿ç”¨ç»Ÿè®¡æŸ¥è¯¢ç»“æœ
- é…ç½®åˆé€‚çš„ç¼“å­˜è¿‡æœŸæ—¶é—´

### è´Ÿè½½å‡è¡¡
- æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²
- ä½¿ç”¨Nginxè¿›è¡Œè´Ÿè½½å‡è¡¡
- é…ç½®å¥åº·æ£€æŸ¥

## ğŸ”§ å¼€å‘å’Œç»´æŠ¤

### å¼€å‘ç¯å¢ƒ
```bash
# å®‰è£…å¼€å‘ä¾èµ–
pip install -r requirements.txt

# è¿è¡Œæµ‹è¯•
pytest tests/

# ä»£ç æ ¼å¼åŒ–
black app/
flake8 app/
```

### æ•°æ®åº“è¿ç§»
```bash
# åˆ›å»ºè¿ç§»
alembic revision --autogenerate -m "æè¿°"

# åº”ç”¨è¿ç§»
alembic upgrade head

# å›æ»šè¿ç§»
alembic downgrade -1
```

### æ—¥å¿—çº§åˆ«é…ç½®
```env
LOG_LEVEL=INFO  # DEBUG, INFO, WARNING, ERROR
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æœåŠ¡çŠ¶æ€æ£€æŸ¥
- **æœåŠ¡åœ°å€**: http://117.72.196.48:8000/
- **å¥åº·æ£€æŸ¥**: http://117.72.196.48:8000/health  
- **APIæ–‡æ¡£**: http://117.72.196.48:8000/admin/docs
- **ç®¡ç†å‘˜è´¦å·**: admin / chen

### è”ç³»æ–¹å¼
å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
1. æäº¤GitHub Issue
2. æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£
3. æ£€æŸ¥æ—¥å¿—è¾“å‡º

---

*Claude API ä¸­è½¬ç«™ v0.1.0 - ä¼ä¸šçº§APIä»£ç†æœåŠ¡*